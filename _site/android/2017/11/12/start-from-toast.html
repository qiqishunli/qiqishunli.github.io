<!DOCTYPE html><html lang="zh">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Android 源码分析 —— 从 Toast 出发 - 浅浅蓝的博客</title>
<meta name="description" content="本系列文章在 https://github.com/mzlogin/rtfsc-android 持续更新中，欢迎有兴趣的童鞋们关注。（图 from Android Developers）Toast 是 Android 开发里较常用的一个类了，有时候用它给用户弹提示信息和界面反馈，有时候用它来作为辅助调试的手段。用...">
<link rel="canonical" href="http://localhost:4000/android/2017/11/12/start-from-toast.html"><link rel="alternate" type="application/rss+xml" title="浅浅蓝的博客" href="http://localhost:4000/feed.xml">
<!-- for Safari on iOS https://developer.apple.com/ios/human-interface-guidelines/icons-and-images/app-icon/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/logo/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/images/logo/icon-167x167.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/logo/icon-152x152.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/logo/icon-120x120.png"><link rel="shortcut icon" href="/assets/images/logo/icon-120x120.png">
<!-- for Chrome on Android https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="192x192" href="/assets/images/logo/icon-192x192.png">
<!-- for Edge on Windows 10 https://msdn.microsoft.com/en-us/library/dn255024(v=vs.85).aspx --><meta name="msapplication-TileImage" content="/assets/images/logo/icon-144x144.png"><meta name="msapplication-square310x310logo" content="/assets/images/logo/icon-310x310.png"><meta name="msapplication-wide310x150logo" content="/assets/images/logo/icon-310x150.png"><meta name="msapplication-square150x150logo" content="/assets/images/logo/icon-150x150.png"><meta name="msapplication-square70x70logo" content="/assets/images/logo/icon-70x70.png">
<meta name="msapplication-TileColor" content="#eeeeee"><link rel="stylesheet" href="/assets/css/blog.css"><script>
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };
  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var Set = (function() {
      var add = function(item) {
        var i, data = this._data;
        for (i = 0; i < data.length; i++) {
          if (data[i] === item) {
            return;
          }
        }
        this.size ++;
        data.push(item);
        return data;
      }

      var Set = function(data) {
        this.size = 0;
        this._data = [];
        if (data.length > 0) {
          for (i = 0; i < data.length; i++) {
            add.call(this, data[i]);
          }
        }
      }
      Set.prototype.add = add;
      Set.prototype.get = function(index) { return this._data[index]; };
      Set.prototype.has = function(item) {
        var i, data = this._data;
        for (i = 0; i < data.length; i++) {
          if (this.get(i) === item) {
            return true;
          }
        }
        return false;
      };
      Set.prototype.is = function(map) {
        if (map._data.length !== this._data.length) { return false; }
        var i, j, flag, tData = this._data, mData = map._data;
        for (i = 0; i < tData.length; i++) {
          for (flag = false, j = 0; j < mData.length; j++) {
            if (tData[i] === mData[j]) {
              flag = true;
              break;
            }
          }
          if (!flag) { return false; }
        }
        return true;
      };
      Set.prototype.values = function() {
        return this._data;
      };
      return Set;
    })();

    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    }
    var end = function(type, url, urls) {
      var s, q, qi, cbs, i, j, cur,
        val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j]
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, si, q, qi, node, i, cur, flag,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  }
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);

  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  }
</script></head>
  <body>
    <div class="m-page-stage js-page-stage">
      <div class="m-page-content"><header class="m-page-header">
  <div class="main clearfix">
    <div class='site-logo'><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#666666;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg><a title="一个热爱前端开发的小姑娘
" href="/">浅浅蓝的博客</a></div>
    <nav>
      <ul><li><a href="/">主页</a></li><li><a href="/all.html">归档</a></li><li><a href="/about.html">关于</a></li><li><a type="application/rss+xml" href="/feed.xml">RSS</a></li>
      </ul>
    </nav>
  </div>
</header>
<div class="m-page-main"><div class="m-post">
	<div class="main clearfix js-main">
		<div class="col-2 js-col-2">
			<aside class="js-article-aside"><div class="m-toc js-toc"></div></aside>
		</div>
		<div class="col-1">
			<article class="js-article" itemscope itemtype="http://schema.org/BlogPosting">
				<meta itemprop="mainEntityOfPage" itemscope itemType="https://schema.org/WebPage"/>
				<header class="main-header"><h1 itemprop="headline" itemprop="name headline">Android 源码分析 —— 从 Toast 出发</h1><div class="m-article-data clearfix"><meta itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="qishunli"/></meta><div class="other-wrapper"><div class="date-wrapper"><time class="article-meta" datetime="2017-11-12T00:00:00+08:00"
          itemprop="datePublished">2017年 11月12日
        </time></div>
  </div>
</div>
</header>
				<div class="m-article-content js-article-content" itemprop="articleBody"><p>本系列文章在 <a href="https://github.com/mzlogin/rtfsc-android">https://github.com/mzlogin/rtfsc-android</a> 持续更新中，欢迎有兴趣的童鞋们关注。</p>

<p><img src="/images/posts/android/toast.png" alt="" /></p>

<p>（图 from Android Developers）</p>

<p>Toast 是 Android 开发里较常用的一个类了，有时候用它给用户弹提示信息和界面反馈，有时候用它来作为辅助调试的手段。用得多了，自然想对其表层之下的运行机制有所了解，所以在此将它选为我的第一个 RTFSC Roots。</p>

<p>本篇采用的记录方式是先对它有个整体的了解，然后提出一些问题，再通过阅读源码，对问题进行一一解读而后得出答案。</p>

<p>本文使用的工具与源码为：Chrome、插件 insight.io、GitHub 项目 <a href="https://github.com/aosp-mirror/platform_frameworks_base">aosp-mirror/platform_frameworks_base</a></p>

<p><strong>目录</strong></p>

<!-- vim-markdown-toc GFM -->

<ul>
  <li><a href="#toast-印象">Toast 印象</a></li>
  <li><a href="#提出问题">提出问题</a></li>
  <li><a href="#解答问题">解答问题</a>
    <ul>
      <li><a href="#toast-的超时时间">Toast 的超时时间</a></li>
      <li><a href="#能不能弹一个时间超长的-toast">能不能弹一个时间超长的 Toast？</a></li>
      <li><a href="#toast-能不能在非-ui-线程调用">Toast 能不能在非 UI 线程调用？</a></li>
      <li><a href="#应用在后台时能不能-toast">应用在后台时能不能 Toast？</a></li>
      <li><a href="#toast-数量有没有限制">Toast 数量有没有限制？</a></li>
      <li><a href="#toastmaketextshow-具体都做了些什么"><code class="highlighter-rouge">Toast.makeText(…).show()</code> 具体都做了些什么？</a></li>
    </ul>
  </li>
  <li><a href="#总结">总结</a>
    <ul>
      <li><a href="#补充后的-toast-知识点列表">补充后的 Toast 知识点列表</a></li>
      <li><a href="#遗留知识点">遗留知识点</a></li>
      <li><a href="#本篇用到的源码分析方法">本篇用到的源码分析方法</a></li>
    </ul>
  </li>
  <li><a href="#后话">后话</a></li>
</ul>

<!-- vim-markdown-toc -->

<h2 id="toast-印象">Toast 印象</h2>

<p>首先我们从 Toast 类的 <a href="1">官方文档</a> 和 <a href="2">API 指南</a> 中可以得出它具备如下特性：</p>

<ol>
  <li>
    <p>Toast 不是 View，它用于帮助创建并展示包含一条小消息的 View；</p>
  </li>
  <li>
    <p>它的设计理念是尽量不惹眼，但又能展示想让用户看到的信息；</p>
  </li>
  <li>
    <p>被展示时，浮在应用界面之上；</p>
  </li>
  <li>
    <p>永远不会获取到焦点；</p>
  </li>
  <li>
    <p>大小取决于消息的长度；</p>
  </li>
  <li>
    <p>超时后会自动消失；</p>
  </li>
  <li>
    <p>可以自定义显示在屏幕上的位置（默认左右居中显示在靠近屏幕底部的位置）；</p>
  </li>
  <li>
    <p>可以使用自定义布局，也只有在自定义布局的时候才需要直接调用 Toast 的构造方法，其它时候都是使用 makeText 方法来创建 Toast；</p>
  </li>
  <li>
    <p>Toast 弹出后当前 Activity 会保持可见性和可交互性；</p>
  </li>
  <li>
    <p>使用 <code class="highlighter-rouge">cancel</code> 方法可以立即将已显示的 Toast 关闭，让未显示的 Toast 不再显示；</p>
  </li>
  <li>
    <p>Toast 也算是一个「通知」，如果弹出状态消息后期望得到用户响应，应该使用 Notification。</p>
  </li>
</ol>

<p>不知道你看到这个列表，是否学到了新知识或者明确了以前不确定的东西，反正我在整理列表的时候是有的。</p>

<h2 id="提出问题">提出问题</h2>

<p>根据以上特性，再结合平时对 Toast 的使用，提出如下问题来继续本次源码分析之旅（大致由易到难排列，后文用 小 demo 或者源码分析来解答）：</p>

<ol>
  <li>
    <p>Toast 的超时时间具体是多少？</p>
  </li>
  <li>
    <p>能不能弹一个时间超长的 Toast？</p>
  </li>
  <li>
    <p>Toast 能不能在非 UI 线程调用？</p>
  </li>
  <li>
    <p>应用在后台时能不能 Toast？</p>
  </li>
  <li>
    <p>Toast 数量有没有限制？</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">Toast.makeText(…).show()</code> 具体都做了些什么？</p>
  </li>
</ol>

<h2 id="解答问题">解答问题</h2>

<h3 id="toast-的超时时间">Toast 的超时时间</h3>

<p>用这样的一个问题开始「Android 源码分析」，真的好怕被打死……大部分人都会嗤之以鼻：Are you kidding me? So easy. 各位大佬们稍安勿躁，阅读大型源码不是个容易的活，让我们从最简单的开始，一点一点建立自信，将这项伟大的事业进行下去。</p>

<p>面对这个问题，我的第一反应是去查 <code class="highlighter-rouge">Toast.LENGTH_LONG</code> 和 <code class="highlighter-rouge">Toast.LENGTH_SHORT</code> 的值，毕竟平时都是用这两个值来控制显示长/短 Toast 的。</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a> 中能看到它们俩的定义是这样的：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Show the view or text notification for a short period of time.  This time
 * could be user-definable.  This is the default.
 * @see #setDuration
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LENGTH_SHORT</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="cm">/**
 * Show the view or text notification for a long period of time.  This time
 * could be user-definable.
 * @see #setDuration
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LENGTH_LONG</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</code></pre></div></div>

<p>啊哦~原来它们只是两个 flag，并非确切的时间值。</p>

<p>既然是 flag，那自然就会有根据不同的 flag 来设置不同的具体值的地方，于是使用 insight.io 点击 <code class="highlighter-rouge">LENGTH_SHORT</code> 的定义搜索一波 <code class="highlighter-rouge">Toast.LENGTH_SHORT</code> 的引用，在 <a href="https://github.com/aosp-mirror/platform_frameworks_base">aosp-mirror/platform_frameworks_base</a> 里一共有 50 处引用，但都是调用 <code class="highlighter-rouge">Toast.makeText(...)</code> 时出现的。</p>

<p>继续搜索 <code class="highlighter-rouge">Toast.LENGTH_LONG</code> 的引用，在 <a href="https://github.com/aosp-mirror/platform_frameworks_base">aosp-mirror/platform_frameworks_base</a> 中共出现 42 次，其中有两处长得像是我们想找的：</p>

<p>第一处，文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TN</span> <span class="kd">extends</span> <span class="n">ITransientNotification</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">SHORT_DURATION_TIMEOUT</span> <span class="o">=</span> <span class="mi">4000</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">LONG_DURATION_TIMEOUT</span> <span class="o">=</span> <span class="mi">7000</span><span class="o">;</span> 
    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShow</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">mParams</span><span class="o">.</span><span class="na">hideTimeoutMilliseconds</span> <span class="o">=</span> <span class="n">mDuration</span> <span class="o">==</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span> <span class="o">?</span> <span class="n">LONG_DURATION_TIMEOUT</span> <span class="o">:</span> <span class="n">SHORT_DURATION_TIMEOUT</span><span class="o">;</span>
        <span class="o">...</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个 hideTimeoutMilliseconds 是干嘛的呢？</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/view/WindowManager.java">platform_frameworks_base/core/java/android/view/WindowManager.java</a> 里能看到这个</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ...
 * ...                                        . Therefore, we do hide
 * such windows to prevent them from overlaying other apps.
 *
 * @hide
 */</span>
<span class="kd">public</span> <span class="kt">long</span> <span class="n">hideTimeoutMilliseconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</code></pre></div></div>

<p>在 GitHub 用 blame 查看到改动这一行的最近一次提交 <a href="https://github.com/aosp-mirror/platform_frameworks_base/commit/aa07653d2eea38a7a5bda5944c8a353586916ae9">aa07653d</a>，它的 commit message 能表明它的用途：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Prevent apps to overlay other apps via toast windows

It was possible for apps to put toast type windows
that overlay other apps which toast winodws aren't
removed after a timeout.

Now for apps targeting SDK greater than N MR1 to add a
toast window one needs to have a special token. The token
is added by the notificatoion manager service only for
the lifetime of the shown toast and is then removed
including all windows associated with this token. This
prevents apps to add arbitrary toast windows.

Since legacy apps may rely on the ability to directly
add toasts we mitigate by allowing these apps to still
add such windows for unlimited duration if this app is
the currently focused one, i.e. the user interacts with
it then it can overlay itself, otherwise we make sure
these toast windows are removed after a timeout like
a toast would be.

We don't allow more that one toast window per UID being
added at a time which prevents 1) legacy apps to put the
same toast after a timeout to go around our new policy
of hiding toasts after a while; 2) modern apps to reuse
the passed token to add more than one window; Note that
the notification manager shows toasts one at a time.
</code></pre></div></div>

<p>它并不是用来控制 Toast 的显示时间的，只是为了防止有些应用的 toast 类型的窗口长期覆盖在别的应用上面，而超时自动隐藏这些窗口的时间，可以看作是一种防护措施。</p>

<p>第二处，文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/notification/NotificationManagerService.java">platform_frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java</a> 里</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">duration</span> <span class="o">==</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span> <span class="o">?</span> <span class="n">LONG_DELAY</span> <span class="o">:</span> <span class="n">SHORT_DELAY</span><span class="o">;</span>
</code></pre></div></div>

<p>在同一文件里能找到 <code class="highlighter-rouge">LONG_DELAY</code> 与 <code class="highlighter-rouge">SHORT_DELAY</code> 的定义：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LONG_DELAY</span> <span class="o">=</span> <span class="n">PhoneWindowManager</span><span class="o">.</span><span class="na">TOAST_WINDOW_TIMEOUT</span><span class="o">;</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SHORT_DELAY</span> <span class="o">=</span> <span class="mi">2000</span><span class="o">;</span> <span class="c1">// 2 seconds</span>
</code></pre></div></div>

<p>点击查看 <code class="highlighter-rouge">PhoneWindowManager.TOAST_WINDOW_TIMEOUT</code> 的定义：</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/policy/PhoneWindowManager.java">platform_frameworks_base/services/core/java/com/android/server/policy/PhoneWindowManager.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Amount of time (in milliseconds) a toast window can be shown. */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TOAST_WINDOW_TIMEOUT</span> <span class="o">=</span> <span class="mi">3500</span><span class="o">;</span> <span class="c1">// 3.5 seconds</span>
</code></pre></div></div>
<p>至此，我们可以得出 <strong>结论：Toast 的长/短超时时间分别为 3.5 秒和 2 秒。</strong></p>

<p><em>Tips: 也可以通过分析代码里的逻辑，一层一层追踪用到 <code class="highlighter-rouge">LENGTH_SHORT</code> 和 <code class="highlighter-rouge">LENGTH_LONG</code> 的地方，最终得出结论，而这里是根据一些合理推断来简化追踪过程，更快达到目标，这在一些场景下是可取和必要的。</em></p>

<h3 id="能不能弹一个时间超长的-toast">能不能弹一个时间超长的 Toast？</h3>

<p>注：这里探讨的是能否直接通过 Toast 提供的公开 API 做到，网络上能搜索到的使用 Timer、反射、自定义等方式达到弹出一个超长时间 Toast 目的的方法不在讨论范围内。</p>

<p>我们在 Toast 类的源码里看一下跟设置时长相关的代码：</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>

    <span class="cm">/** @hide */</span>
    <span class="nd">@IntDef</span><span class="o">({</span><span class="n">LENGTH_SHORT</span><span class="o">,</span> <span class="n">LENGTH_LONG</span><span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">SOURCE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Duration</span> <span class="o">{}</span>

<span class="o">...</span>

    <span class="cm">/**
     * Set how long to show the view for.
     * @see #LENGTH_SHORT
     * @see #LENGTH_LONG
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDuration</span><span class="o">(</span><span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>
        <span class="n">mTN</span><span class="o">.</span><span class="na">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">...</span>

    <span class="cm">/**
     * Make a standard toast that just contains a text view.
     *
     * @param context  The context to use.  Usually your {@link android.app.Application}
     *                 or {@link android.app.Activity} object.
     * @param text     The text to show.  Can be formatted text.
     * @param duration How long to display the message.  Either {@link #LENGTH_SHORT} or
     *                 {@link #LENGTH_LONG}
     *
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">...</span>
</code></pre></div></div>

<p>其实从上面 <code class="highlighter-rouge">setDuration</code> 和 <code class="highlighter-rouge">makeText</code> 的注释已经可以看出，duration 只能取值 <code class="highlighter-rouge">LENGTH_SHORT</code> 和 <code class="highlighter-rouge">LENGTH_LONG</code>，除了注释之外，还使用了 <code class="highlighter-rouge">@Duration</code> 注解来保证此事。<code class="highlighter-rouge">Duration</code> 自身使用了 <code class="highlighter-rouge">@IntDef</code> 注解，它用于限制可以取的值。</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/annotation/IntDef.java">platform_frameworks_base/core/java/android/annotation/IntDef.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Denotes that the annotated element of integer type, represents
 * a logical type and that its value should be one of the explicitly
 * named constants. If the {@link #flag()} attribute is set to true,
 * multiple constants can be combined.
 * ...
 */</span>
</code></pre></div></div>

<p>不信邪的我们可以快速在一个 demo Android 工程里写一句这样的代码试试：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Hello"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
</code></pre></div></div>

<p>Android Studio 首先就不会同意，警告你 <code class="highlighter-rouge">Must be one of: Toast.LENGTH_SHORT, Toast.LENGTH_LONG</code>，但实际这段代码是可以通过编译的，因为 <code class="highlighter-rouge">Duration</code> 注解的 <code class="highlighter-rouge">Retention</code> 为 <code class="highlighter-rouge">RetentionPolicy.SOURCE</code>，我的理解是该注解主要能用于 IDE 的智能提示警告，编译期就被丢掉了。</p>

<p>但即使 duration 能传入 <code class="highlighter-rouge">LENGTH_SHORT</code> 和 <code class="highlighter-rouge">LENGTH_LONG</code> 以外的值，也并没有什么卵用，别忘了这里设置的只是一个 flag，真正计算的时候是 <code class="highlighter-rouge">long delay = r.duration == Toast.LENGTH_LONG ? LONG_DELAY : SHORT_DELAY;</code>，即 duration 为 <code class="highlighter-rouge">LENGTH_LONG</code> 时时长为 3.5 秒，其它情况都是 2 秒。</p>

<p>所以我们可以得出 <strong>结论：无法通过 Toast 提供的公开 API 直接弹出超长时间的 Toast。</strong>（如节首所述，可以通过一些其它方式实现类似的效果）</p>

<h3 id="toast-能不能在非-ui-线程调用">Toast 能不能在非 UI 线程调用？</h3>

<p>这个问题适合用一个 demo 来解答。</p>

<p>我们创建一个最简单的 App 工程，然后在启动 Activity 的 onCreate 方法里添加这样一段代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"Call toast on non-UI thread"</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<p>啊哦~很遗憾程序直接挂掉了。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11-07 13:35:33.980 2020-2035/org.mazhuang.androiduidemos E/AndroidRuntime: FATAL EXCEPTION: Thread-77
    java.lang.RuntimeException: Can't create handler inside thread that has not called Looper.prepare()
        at android.widget.Toast$TN.&lt;init&gt;(Toast.java:390)
        at android.widget.Toast.&lt;init&gt;(Toast.java:114)
        at android.widget.Toast.makeText(Toast.java:277)
        at android.widget.Toast.makeText(Toast.java:267)
        at org.mazhuang.androiduidemos.MainActivity$1.run(MainActivity.java:27)
        at java.lang.Thread.run(Thread.java:856)
</code></pre></div></div>

<p>顺着堆栈里显示的方法调用从下往上一路看过去，</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<p>首先是两级 makeText 方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 我们的代码里调用的 makeText 方法</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 隐藏的 makeText 方法，不能手动调用</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Toast</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Toast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span> <span class="c1">// 这里的 looper 为 null</span>
    <span class="o">...</span>
</code></pre></div></div>

<p>然后到了 Toast 的构造方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">Toast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">mTN</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TN</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">looper</span><span class="o">);</span> <span class="c1">// looper 为 null</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>到 Toast$TN 的构造方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// looper = null</span>
<span class="n">TN</span><span class="o">(</span><span class="n">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Use Looper.myLooper() if looper is not specified.</span>
        <span class="n">looper</span> <span class="o">=</span> <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                    <span class="s">"Can't toast on a thread that has not called Looper.prepare()"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>至此，我们已经追踪到了我们的崩溃的 RuntimeException，即要避免进入抛出异常的逻辑，要么调用的时候传递一个 Looper 进来（无法直接实现，能传递 Looper 参数的构造方法与 makeText 方法是 hide 的），要么 <code class="highlighter-rouge">Looper.myLooper()</code> 返回不为 null，提示信息 <code class="highlighter-rouge">Can't create handler inside thread that has not called Looper.prepare()</code> 里给出了方法，那我们在 toast 前面加一句 <code class="highlighter-rouge">Looper.prepare()</code> 试试？这次不崩溃了，但依然不弹出 Toast，毕竟，这个线程在调用完 <code class="highlighter-rouge">show()</code> 方法后就直接结束了，没有调用 <code class="highlighter-rouge">Looper.loop()</code>，至于为什么调用 Toast 的线程结束与否会对 Toast 的显示隐藏等起影响，在本文的后面的章节里会进行分析。</p>

<p>从崩溃提示来看，Android 并没有限制在非 UI 线程里使用 Toast，只是线程得是一个有 Looper 的线程。于是我们尝试构造如下代码，发现可以成功从非 UI 线程弹出 toast 了：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">MSG_TOAST</span> <span class="o">=</span> <span class="mi">101</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">MSG_QUIT</span> <span class="o">=</span> <span class="mi">102</span><span class="o">;</span>

        <span class="n">Looper</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>

                <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nl">MSG_TOAST:</span>
                        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"Call toast on non-UI thread"</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
                        <span class="n">sendEmptyMessageDelayed</span><span class="o">(</span><span class="n">MSG_QUIT</span><span class="o">,</span> <span class="mi">4000</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>

                    <span class="k">case</span> <span class="nl">MSG_QUIT:</span>
                        <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">().</span><span class="na">quit</span><span class="o">();</span>
                        <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">handler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_TOAST</span><span class="o">);</span>

        <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<p>至于为什么 <code class="highlighter-rouge">sendEmptyMesageDelayed(MSG_QUIT, 4000)</code> 里的 delayMillis 我设成了 4000，这里卖个关子，感兴趣的同学可以把这个值调成 0、1000 等等看一下效果，会有一些意想不到的情况发生。</p>

<p>到此，我们可以得出 <strong>结论：可以在非 UI 线程里调用 Toast，但是得是一个有 Looper 的线程。</strong></p>

<p>ps. 上面这一段演示代码让人感觉为了弹出一个 Toast 好麻烦，也可以采用 Activity.runOnUiThread、View.post 等方法从非 UI 线程将逻辑切换到 UI 线程里执行，直接从 UI 线程里弹出，UI 线程是有 Looper 的。</p>

<p><em>知识点：这里如果对 Looper、Handler 和 MessageQueue 有所了解，就容易理解多了，预计下一篇对这三剑客进行讲解。</em></p>

<h3 id="应用在后台时能不能-toast">应用在后台时能不能 Toast？</h3>

<p>这个问题也比较适合用一个简单的 demo 来尝试回答。</p>

<p>在 MainActivity 的 onCreate 里加上这样一段代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">view</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"background toast"</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">},</span> <span class="mi">5000</span><span class="o">);</span>
</code></pre></div></div>

<p>然后待应用启动后按 HOME 键，等几秒看是否能弹出该 Toast 即可。</p>

<p><strong>结论是：应用在后台时可以弹出 Toast。</strong></p>

<h3 id="toast-数量有没有限制">Toast 数量有没有限制？</h3>

<p>这个问题将在下一节中一并解答。</p>

<h3 id="toastmaketextshow-具体都做了些什么"><code class="highlighter-rouge">Toast.makeText(…).show()</code> 具体都做了些什么？</h3>

<p>首先看一下 makeText 方法。</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Make a standard toast to display using the specified looper.
 * If looper is null, Looper.myLooper() is used.
 * @hide
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Toast</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Toast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span>

    <span class="n">LayoutInflater</span> <span class="n">inflate</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutInflater</span><span class="o">)</span>
            <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LAYOUT_INFLATER_SERVICE</span><span class="o">);</span>
    <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">inflate</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">transient_notification</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span><span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>

    <span class="n">result</span><span class="o">.</span><span class="na">mNextView</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="n">result</span><span class="o">.</span><span class="na">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个方法里就是构造了一个 Toast 对象，将需要展示的 View 准备好，设置好超时时长标记，我们可以看一下 <code class="highlighter-rouge">com.android.internal.R.layout.transient_notification</code> 这个布局的内容：</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/res/res/layout/transient_notification.xml">platform_frameworks_base/core/res/res/layout/transient_notification.xml</a></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
    <span class="na">android:orientation=</span><span class="s">"vertical"</span>
    <span class="na">android:background=</span><span class="s">"?android:attr/toastFrameBackground"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">"@android:id/message"</span>
        <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_weight=</span><span class="s">"1"</span>
        <span class="na">android:layout_marginHorizontal=</span><span class="s">"24dp"</span>
        <span class="na">android:layout_marginVertical=</span><span class="s">"15dp"</span>
        <span class="na">android:layout_gravity=</span><span class="s">"center_horizontal"</span>
        <span class="na">android:textAppearance=</span><span class="s">"@style/TextAppearance.Toast"</span>
        <span class="na">android:textColor=</span><span class="s">"@color/primary_text_default_material_light"</span>
        <span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</code></pre></div></div>

<p>我们最常见的 Toast 就是从这个布局文件渲染出来的了。</p>

<p>我们继续看一下 makeText 里调用的 Toast 的构造方法里做了哪些事情：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Constructs an empty Toast object.  If looper is null, Looper.myLooper() is used.
 * @hide
 */</span>
<span class="kd">public</span> <span class="nf">Toast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">mTN</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TN</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">looper</span><span class="o">);</span>
    <span class="n">mTN</span><span class="o">.</span><span class="na">mY</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getDimensionPixelSize</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">dimen</span><span class="o">.</span><span class="na">toast_y_offset</span><span class="o">);</span>
    <span class="n">mTN</span><span class="o">.</span><span class="na">mGravity</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getInteger</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">integer</span><span class="o">.</span><span class="na">config_toastDefaultGravity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>主要就是构造了一个 TN 对象，计算了位置。</p>

<p>TN 的构造方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TN</span><span class="o">(</span><span class="n">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// XXX This should be changed to use a Dialog, with a Theme.Toast</span>
    <span class="c1">// defined that sets up the layout params appropriately.</span>
    <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span> <span class="o">=</span> <span class="n">mParams</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">format</span> <span class="o">=</span> <span class="n">PixelFormat</span><span class="o">.</span><span class="na">TRANSLUCENT</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">windowAnimations</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">Animation_Toast</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_TOAST</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"Toast"</span><span class="o">);</span>
    <span class="n">params</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_KEEP_SCREEN_ON</span>
            <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_FOCUSABLE</span>
            <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_TOUCHABLE</span><span class="o">;</span>

    <span class="n">mPackageName</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Use Looper.myLooper() if looper is not specified.</span>
        <span class="n">looper</span> <span class="o">=</span> <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                    <span class="s">"Can't toast on a thread that has not called Looper.prepare()"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<p>设置了 LayoutParams 的初始值，在后面 show 的时候会用到，设置了包名和 Looper、Handler。</p>

<p>TN 是 App 中用于与 Notification Service 交互的对象，这里涉及到 Binder 和跨进程通信的知识，这块会在后面开新篇来讲解，这里可以简单地理解一下：Notification Service 是系统为了管理各种 App 的 Notification（包括 Toast）的服务，比如 Toast，由这个服务来统一维护一个待展示 Toast 队列，各 App 需要弹 Toast 的时候就将相关信息发送给这个服务，服务会将其加入队列，然后根据队列的情况，依次通知各 App 展示和隐藏 Toast。</p>

<p>接下来看看 show 方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Show the view for the specified duration.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mNextView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"setView must have been called"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">INotificationManager</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getOpPackageName</span><span class="o">();</span>
    <span class="n">TN</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">mTN</span><span class="o">;</span>
    <span class="n">tn</span><span class="o">.</span><span class="na">mNextView</span> <span class="o">=</span> <span class="n">mNextView</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">service</span><span class="o">.</span><span class="na">enqueueToast</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">tn</span><span class="o">,</span> <span class="n">mDuration</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Empty</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>调用了 INotificationManager 的 enqueueToast 方法，INotificationManager 是一个接口，其实现类在 NotificationManagerService 里，我们来看 enqueueToast 方法的实现：</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/notification/NotificationManagerService.java">platform_frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueueToast</span><span class="o">(</span><span class="n">String</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">ITransientNotification</span> <span class="n">callback</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span>
<span class="o">{</span>
    <span class="o">...</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ToastRecord</span> <span class="n">record</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexOfToastLocked</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
            <span class="c1">// If it's already in the queue, we update it in place, we don't</span>
            <span class="c1">// move it to the end of the queue.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="n">record</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">duration</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// Limit the number of toasts that any given package except the android</span>
                <span class="c1">// package can enqueue.  Prevents DOS attacks and deals with leaks.</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">isSystemToast</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                         <span class="kd">final</span> <span class="n">ToastRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                         <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
                             <span class="n">count</span><span class="o">++;</span>
                             <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_PACKAGE_NOTIFICATIONS</span><span class="o">)</span> <span class="o">{</span>
                                 <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Package has already posted "</span> <span class="o">+</span> <span class="n">count</span>
                                        <span class="o">+</span> <span class="s">" toasts. Not showing more. Package="</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">);</span>
                                 <span class="k">return</span><span class="o">;</span>
                             <span class="o">}</span>
                         <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">Binder</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Binder</span><span class="o">();</span>
                <span class="n">mWindowManagerInternal</span><span class="o">.</span><span class="na">addWindowToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">TYPE_TOAST</span><span class="o">,</span> <span class="n">DEFAULT_DISPLAY</span><span class="o">);</span>
                <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToastRecord</span><span class="o">(</span><span class="n">callingPid</span><span class="o">,</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
                <span class="n">mToastQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
                <span class="n">keepProcessAliveIfNeededLocked</span><span class="o">(</span><span class="n">callingPid</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// If it's at index 0, it's the current toast.  It doesn't matter if it's</span>
            <span class="c1">// new or just been updated.  Call back and tell it to show itself.</span>
            <span class="c1">// If the callback fails, this will remove it from the list, so don't</span>
            <span class="c1">// assume that it's valid after this.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">showNextToastLocked</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">callingId</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>主要就是使用调用方传来的包名、callback 和 duration 构造一个 ToastRecord，然后添加到 mToastQueue 中。如果在 mToastQueue 中已经存在该包名和 callback 的 Toast，则只更新其 duration。</p>

<p>这段代码里有一段可以回答我们的上一个问题 <code class="highlighter-rouge">Toast 数量有没有限制</code> 了：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Limit the number of toasts that any given package except the android</span>
<span class="c1">// package can enqueue.  Prevents DOS attacks and deals with leaks.</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">isSystemToast</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="n">ToastRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
             <span class="n">count</span><span class="o">++;</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_PACKAGE_NOTIFICATIONS</span><span class="o">)</span> <span class="o">{</span>
                 <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Package has already posted "</span> <span class="o">+</span> <span class="n">count</span>
                        <span class="o">+</span> <span class="s">" toasts. Not showing more. Package="</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">);</span>
                 <span class="k">return</span><span class="o">;</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>即会计算 mToastQueue 里该包名的 Toast 数量，如果超过 50，则将当前申请加入队列的 Toast 抛弃掉。所以上一个问题的 <strong>结论是：Toast 队列里允许每个应用存在不超过 50 个 Toast。</strong></p>

<p>那么构造 ToastRecord 并加入 mToastQueue 之后是如何调度，控制显示和隐藏的呢？enqueueToast 方法里有个逻辑是如果当前列表里只有一个 ToastRecord，则调用 <code class="highlighter-rouge">showNextToastLocked</code>，看一下与该方法相关的代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"mToastQueue"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">showNextToastLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">ToastRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">record</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
            <span class="n">scheduleTimeoutLocked</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mToastQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"mToastQueue"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">scheduleTimeoutLocked</span><span class="o">(</span><span class="n">ToastRecord</span> <span class="n">r</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacksAndMessages</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="n">Message</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">mHandler</span><span class="o">,</span> <span class="n">MESSAGE_TIMEOUT</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">duration</span> <span class="o">==</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span> <span class="o">?</span> <span class="n">LONG_DELAY</span> <span class="o">:</span> <span class="n">SHORT_DELAY</span><span class="o">;</span>
    <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">delay</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleTimeout</span><span class="o">(</span><span class="n">ToastRecord</span> <span class="n">record</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">DBG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Timeout pkg="</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">pkg</span> <span class="o">+</span> <span class="s">" callback="</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">);</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexOfToastLocked</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">pkg</span><span class="o">,</span> <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cancelToastLocked</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"mToastQueue"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">cancelToastLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ToastRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">.</span><span class="na">hide</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="n">ToastRecord</span> <span class="n">lastToast</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="n">mWindowManagerInternal</span><span class="o">.</span><span class="na">removeWindowToken</span><span class="o">(</span><span class="n">lastToast</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">DEFAULT_DISPLAY</span><span class="o">);</span>

    <span class="n">keepProcessAliveIfNeededLocked</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Show the next one. If the callback fails, this will remove</span>
        <span class="c1">// it from the list, so don't assume that the list hasn't changed</span>
        <span class="c1">// after this point.</span>
        <span class="n">showNextToastLocked</span><span class="o">();</span> <span class="c1">// 继续显示队列里的下一个 Toast</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WorkerHandler</span> <span class="kd">extends</span> <span class="n">Handler</span>
<span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">case</span> <span class="nl">MESSAGE_TIMEOUT:</span>
                <span class="n">handleTimeout</span><span class="o">((</span><span class="n">ToastRecord</span><span class="o">)</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>即首先调用 <code class="highlighter-rouge">record.callback.show(record.token)</code>，通知 App 展示该 Toast，然后根据 duration，延时发送一条超时消息 <code class="highlighter-rouge">MESSAGE_TIMEOUT</code>，WorkHandler 收到该消息后，调用 <code class="highlighter-rouge">cancelToastLocked</code> 通知应用隐藏该 Toast，并继续调用 <code class="highlighter-rouge">showNextToastLocked</code> 显示队列里的下一个 Toast。这样一个机制就保证了只要队列里有 ToastRecord，就能依次显示出来。</p>

<p>机制弄清楚了，再详细看一下应用接到通知 show 和 hide 一个 Toast 后是怎么做的：</p>

<p>文件 <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TN</span> <span class="kd">extends</span> <span class="n">ITransientNotification</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">TN</span><span class="o">(</span><span class="n">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nl">SHOW:</span> <span class="o">{</span>
                        <span class="n">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="o">(</span><span class="n">IBinder</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>
                        <span class="n">handleShow</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">case</span> <span class="nl">HIDE:</span> <span class="o">{</span>
                        <span class="n">handleHide</span><span class="o">();</span>
                        <span class="o">...</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="o">...</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="cm">/**
     * schedule handleShow into the right thread
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"SHOW: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">SHOW</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">).</span><span class="na">sendToTarget</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * schedule handleHide into the right thread
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hide</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"HIDE: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">HIDE</span><span class="o">).</span><span class="na">sendToTarget</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShow</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
                <span class="n">mWM</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">mView</span><span class="o">,</span> <span class="n">mParams</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleHide</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
                <span class="n">mWM</span><span class="o">.</span><span class="na">removeViewImmediate</span><span class="o">(</span><span class="n">mView</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>显示过程：show 方法被远程调用后，先是发送了一个 SHOW 消息，接收到该消息后调用了 handleShow 方法，然后 <code class="highlighter-rouge">mWM.addView</code> 将该 View 添加到窗口。</p>

<p>隐藏过程：hide 方法被远程调用后，先是发送了一个 HIDE 消息，接收到该消息后调用了 handleHide 方法，然后 <code class="highlighter-rouge">mWM.removeViewImmediate</code> 将该 View 从窗口移除。</p>

<p><em>这里插播一条结论，就是前文留下的为什么调用 Toast 的线程线束之后没弹出的 Toast 就无法弹出了的问题，因为 Notification Service 通知应用进程显示或隐藏 Toast 时，使用的是 <code class="highlighter-rouge">mHandler.obtainMessage(SHOW).sendToTarget()</code> 与 <code class="highlighter-rouge">mHandler.obtainMessage(HIDE).sendToTarget()</code>，这个消息发出去后，Handler 对应线程没有在 <code class="highlighter-rouge">Looper.loop()</code> 过程里的话，就没有办法进入到 Handler 的 handleMessage 方法里去，自然也就无法调用显示和隐藏 View 的流程了。<code class="highlighter-rouge">Looper.loop()</code> 相关的知识点将在下篇讲解。</em></p>

<h2 id="总结">总结</h2>

<h3 id="补充后的-toast-知识点列表">补充后的 Toast 知识点列表</h3>

<ol>
  <li>
    <p>Toast 不是 View，它用于帮助创建并展示包含一条小消息的 View；</p>
  </li>
  <li>
    <p>它的设计理念是尽量不惹眼，但又能展示想让用户看到的信息；</p>
  </li>
  <li>
    <p>被展示时，浮在应用界面之上；</p>
  </li>
  <li>
    <p>永远不会获取到焦点；</p>
  </li>
  <li>
    <p>大小取决于消息的长度；</p>
  </li>
  <li>
    <p>超时后会自动消失；</p>
  </li>
  <li>
    <p>可以自定义显示在屏幕上的位置（默认左右居中显示在靠近屏幕底部的位置）；</p>
  </li>
  <li>
    <p>可以使用自定义布局，也只有在自定义布局的时候才需要直接调用 Toast 的构造方法，其它时候都是使用 makeText 方法来创建 Toast；</p>
  </li>
  <li>
    <p>Toast 弹出后当前 Activity 会保持可见性和可交互性；</p>
  </li>
  <li>
    <p>使用 <code class="highlighter-rouge">cancel</code> 方法可以立即将已显示的 Toast 关闭，让未显示的 Toast 不再显示；</p>
  </li>
  <li>
    <p>Toast 也算是一个「通知」，如果弹出状态消息后期望得到用户响应，应该使用 Notification；</p>
  </li>
  <li>
    <p>Toast 的超时时间为 LENGTH_SHORT 对应 2 秒，LENGTH_LONG 对应 3.5 秒；</p>
  </li>
  <li>
    <p>不能通过 Toast 类的公开方法直接弹一个时间超长的 Toast；</p>
  </li>
  <li>
    <p>应用在后台时可以调用 Toast 并正常弹出；</p>
  </li>
  <li>
    <p>Toast 队列里允许单个应用往里添加 50 个 Toast，超出的将被丢弃。</p>
  </li>
</ol>

<h3 id="遗留知识点">遗留知识点</h3>

<p>本篇涉及到了一些需要进一步了解的知识点，在后续的篇章中会依次解读：</p>

<ol>
  <li>
    <p>Handler、Looper 和 MessageQueue</p>
  </li>
  <li>
    <p>WindowManager</p>
  </li>
  <li>
    <p>Binder 与跨进程通信</p>
  </li>
</ol>

<h3 id="本篇用到的源码分析方法">本篇用到的源码分析方法</h3>

<ol>
  <li>
    <p>查找关键变量被引用的地方；</p>
  </li>
  <li>
    <p>按方法调用堆栈一层层逻辑跟踪与分析；</p>
  </li>
  <li>
    <p>使用 git blame 查看关键代码行的变更日志；</p>
  </li>
</ol>

<h2 id="后话">后话</h2>

<p>到此，上面提到的几个问题都已经解答完毕，对 Toast 源码的分析也告一段落。</p>

<p>写这篇文章花费的时间比较长，所以并不能按照预计的节奏更新，这里表示抱歉。另外，各位如果有耐心读到这里，觉得本文的思路是否清晰，是否能跟随文章的节奏理解一些东西？因为我也在摸索写这类文章的组织形式，所以也希望能收到反馈和建议，以作改进，先行谢过。</p>

<hr />

<p>最后，照例要安利一下我的微信公众号「闷骚的程序员」，扫码关注，接收 rtfsc-android 的最近更新。</p>

<div align="center"><img width="192px" height="192px" src="http://mazhuang.org/assets/images/qrcode.jpg" /></div>

</div>
				<footer><meta itemprop="dateModified" content="2017-11-12T00:00:00+08:00"><div class="article-license"><div class="m-license"><div class="clearfix"><p>本文遵守 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> 许可协议。</p><a class="license" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
      <img alt="Creative Commons License" src="/assets/images/license-cc4.png" />
    </a><p>欢迎转载，转载需注明出处，且禁止用于商业目的。</p>
  </div>
</div></div>
				</footer>
			</article>
			<div class="article-previous-next clearfix"><div class="article-previous"><span>上篇</span><a href="/android/2017/12/03/tcp-connect-between-android-emulators.html">解决两个 Android 模拟器之间无法网络通信的问题</a></div><div class="article-next"><span>下篇</span><a href="/blog/2017/10/24/1024-poses.html">程序员节的过节姿势大全</a></div></div></div>
	</div>
</div></div>
      </div>
    </div><div class="m-page-footer js-page-footer">
  <div class="main">
    <aside><div class="follow-me"><ul itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="qishunli">
    <link itemprop="url" href="http://localhost:4000/"><li title="在 Weibo 上关注我。">
        <div class="floating-action-round-button weibo">
          <a itemprop="sameAs" href="https://weibo.com/浅浅蓝_qsl" target="_blank">
            <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
	<path d="M769.226164 496.610234c-14.420098-4.330228-24.309277-7.266877-16.746482-26.214823 16.350218-41.133578 18.046881-76.626289 0.307181-101.939024-33.242099-47.500415-124.194284-44.928286-228.44638-1.280945 0-0.056317-32.73525 14.323848-24.371737-11.64523 16.042013-51.54906 13.626547-94.739726-11.332929-119.662341-56.566349-56.601163-206.976479 2.134908-335.954595 131.078209-96.594075 96.61353-152.681222 198.989775-152.681222 287.52035 0 169.337597 217.152361 272.292366 429.593589 272.292366 278.498445 0 463.752111-161.808592 463.752111-290.273715C893.345701 558.867622 827.968378 514.820945 769.226164 496.610234zM430.163922 866.063936c-169.51781 16.728051-315.851649-59.899262-326.864086-171.202185-11.010389-111.275277 117.530505-215.061482 287.031932-231.823323 169.537265-16.761841 315.876224 59.866496 326.86511 171.119247C728.190884 745.495411 599.705282 849.291856 430.163922 866.063936z" />
	<path d="M954.16753 186.714824c-67.256246-74.565105-166.457264-102.990607-258.020739-83.522502l-0.037886 0c-21.188318 4.535015-34.695065 25.37929-30.159026 46.527675 4.516584 21.166816 25.352668 34.691993 46.54201 30.174385 65.139769-13.832358 135.634727 6.400627 183.442323 59.368863 47.765615 52.96414 60.740938 125.206957 40.282686 188.537431l0.011263 0.012287c-6.666851 20.629249 4.617954 42.698153 25.271777 49.366027 20.570885 6.662755 42.687913-4.607714 49.362955-25.188838 0-0.037886 0-0.116729 0.011263-0.150519C1039.577146 362.756133 1021.443231 261.206205 954.16753 186.714824" />
	<path d="M850.886125 279.919669c-32.732179-36.315956-81.068126-50.108381-125.685136-40.621609-18.234261 3.885839-29.856965 21.833398-25.946551 40.085067 3.89915 18.173849 21.833398 29.851845 40.024654 25.893307l0 0.037886c21.809848-4.610786 45.459709 2.113405 61.461789 19.83365 16.018463 17.757107 20.323092 41.949655 13.45043 63.178931l0.035838 0c-5.715614 17.717174 3.983113 36.770584 21.717694 42.511796 17.7397 5.677728 36.76956-3.992328 42.493365-21.756603C892.458972 365.691759 883.686907 316.228458 850.886125 279.919669" />
	<path d="M447.103928 548.691741c-80.666743-20.985579-171.84317 19.215193-206.880229 90.291746-35.685212 72.492657-1.180599 152.963828 80.321676 179.268757 84.41947 27.224424 183.926645-14.492797 218.521364-92.744074C573.187374 649.021137 530.586496 570.268131 447.103928 548.691741zM385.506979 733.819463c-16.398343 26.160554-51.51015 37.623523-77.954335 25.54824-26.066352-11.868448-33.760211-42.248645-17.360844-67.757975 16.197652-25.400793 50.129884-36.716316 76.378497-25.711046C393.129162 677.216253 401.60838 707.401901 385.506979 733.819463zM439.522702 664.493841c-5.929616 10.131852-19.03498 15.010909-29.304039 10.785123-10.096014-4.15411-13.261002-15.495231-7.522862-25.454038 5.906066-9.908634 18.500485-14.747758 28.572948-10.750309C441.502995 642.817105 445.180975 654.283146 439.522702 664.493841z" />
</svg>
</div>
          </a>
        </div>
      </li><li title="在 Github 上关注我。">
        <div class="floating-action-round-button github">
          <a itemprop="sameAs" href="https://github.com/qiqishunli" target="_blank">
            <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
          </a>
        </div>
      </li></ul><p class="email">
      <a title="给我发邮件。" href="mailto:shunliqi@163.com" target="_self">shunliqi@163.com</a>
    </p></div>
</aside>
    <footer class="site-info">
      <p>© 浅浅蓝的博客 2018</p>
      <p>Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a succinct theme for blogging." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.</p>
    </footer>
  </div>
</div><script>
  (function () {
    var root = document.body
    function classnames(classes) {
      var i, cur, _classes = '';
      if (window.isString(classes)) {
        _classes =  classes;
      } else if (window.isArray(classes)) {
        for (i = 0; i < classes.length; i++) {
          cur = classes[i];
          if (window.isString(cur)) {
            _classes = _classes.concat(_classes ? ' ' + cur : cur);
          }
        }
      } else {
        return '';
      }
      return _classes;
    }
    function addClass(dom, classname) {
      dom.setAttribute('class', classnames([dom.getAttribute('class'), classname]));
    }
    if (window.hasEvent('touchstart')) {
      addClass(root, 'is-touch');
      document.addEventListener("touchstart", function(){}, false);
    } else {
      addClass(root, 'not-touch');
    }
  })();
</script><script>
  (function() {
    function scrollAnimateTo(destination, duration, callback) {
      var $body = $('html, body'), bodyScrollTop = $body.scrollTop();
      if(bodyScrollTop === destination) { return; }
      $body.animate({ scrollTop: destination }, duration, callback);
    }
    window.scrollTopAnchor = function(anchor, callback) {
      scrollAnimateTo($(anchor).offset().top, 400, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
  })();
  window.Lazyload.js('https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', function() {
    var $articleContent = $('.m-post, .m-page').find('.m-article-content'), $this;
    $articleContent.children('.highlight').each(function() {
      $this = $(this);
      $this.attr('data-lang', $this.find('code').attr('data-lang'));
    });

    $articleContent.children('h1, h2, h3, h4, h5, h6').each(function() {
      $this = $(this);
      $this.append($('<a class="anchor" aria-hidden="true"></a>').html('<svg fill="#000000" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'));
    });
    $articleContent.on('click', '.anchor', function() {
      window.scrollTopAnchor('#' + $(this).parent().attr('id'));
    });
  });
</script><script>
  window.Lazyload.js('https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', function() {
    var $window = $(window);
    var $pageStage = $('.js-page-stage');
    var $pageMain = $('.js-main');
    var $pageFooter = $('.js-page-footer');
    var $articleContent = $('.js-article-content');
    var $articleAside = $('.js-article-aside');
    var $toc = $('.js-toc');
    var $col2 = $('.js-col-2');
    var hasTitle = $articleContent.find('h1,h2,h3').length > 0;
    function asideSticky() {
      return $col2.css('display') !== 'none' && $pageStage.hasClass('has-toc');
    }
    function setTocClass() {
      if (hasTitle) {
        !$pageStage.hasClass('has-toc') && $pageStage.addClass('has-toc');
      }
    }
    function setAsideTOC() {
      var asideTop, asideLeft, scrollBottom, asideBottomTop, lastScrollTop;
      function init() {
        var asideOffset = $articleAside.offset();
        var footerOffset = $pageFooter.offset();
        var mainOffset = $pageMain.offset();
        asideTop = mainOffset.top;
        asideHeight = $toc.outerHeight() + parseInt($articleAside.css('padding-top'), 10) + parseInt($articleAside.css('padding-bottom'), 10);
        asideLeft = mainOffset.left + $pageMain.outerWidth() - $articleAside.outerWidth() - parseInt($pageMain.css('padding-right'), 10);
        scrollBottom = footerOffset.top - asideHeight;
        asideBottomTop = scrollBottom - mainOffset.top;
      }
      function setAside(force) {
        force !== true && (force = false);
        var scrollTop = $window.scrollTop();
        if (scrollTop >= asideTop && scrollTop <= scrollBottom) {
          (!force && lastScrollTop >= asideTop && lastScrollTop <= scrollBottom) ||
          $articleAside.addClass('fixed').css({
            left: asideLeft + 'px',
            top: 0
          });
        } else if (scrollTop < asideTop) {
          (!force && lastScrollTop < asideTop) ||
          $articleAside.removeClass('fixed').css({
            left: 0,
            top: 0
          });
        } else {
          (!force && lastScrollTop > scrollBottom) ||
          $articleAside.removeClass('fixed').css({
            left: 0,
            top: asideBottomTop + 'px'
          });
        }
        lastScrollTop = scrollTop;
      }
      asideSticky() && (init(), setAside());
      $window.on('scroll', function() {
        asideSticky() && setAside();
      });
      $window.on('resize', window.throttle(function() {
        setTocClass();
        asideSticky() && (init(), setAside(true));
      }, 100));
      setTimeout(init, 4000);
    }
    function toc() {
      var $tocUl = $('<ul></ul>'), $tocLi, $headings = $articleContent.find('h1,h2,h3'), headingsTop = [],
        scrolling, activeLast, activeCur, rendered = false;
      function init() {
        $headings.each(function() {
          headingsTop.push(Math.floor($(this).offset().top));
        });
      }
      function setActiveHeading(element, disabled) {
        var scrollTop = $window.scrollTop(), i;
        if (disabled || headingsTop.length < 1) { return; }
        if (element) {
          activeCur = element;
        } else {
          for (i = 0; i < headingsTop.length; i++) {
            if (scrollTop >= headingsTop[i]) {
              activeCur = $tocLi.eq(i);
            } else {
              activeCur || (activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        activeLast && activeLast.removeClass('toc-active');
        (activeLast = activeCur).addClass('toc-active');
      }
      function render() {
        $toc.append($tocUl);
        $headings.each(function() {
          var $this = $(this);
          $tocUl.append($('<li></li>').addClass('toc-' + $this.prop("tagName").toLowerCase())
            .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
        });
        $tocLi = $tocUl.children('li');
        $tocUl.on('click', 'a', function(e) {
          e.preventDefault();
          var $this = $(this);
          scrolling = true;
          setActiveHeading($this.parent());
          window.scrollTopAnchor($this.attr('href'), function() {
            scrolling = false;
          });
        });
        rendered = true;
      }
      asideSticky() && (render(), $window.on('load', function() {
        setTimeout(function() {
          init();
          setActiveHeading(null, scrolling);
        }, 1000);
      }));
      $window.on('resize', window.throttle(function() {
        if (asideSticky()) {
          rendered || render();
          init();
          setActiveHeading(null, scrolling);
        }
      }));
      $window.on('scroll', function() {
        asideSticky() && setActiveHeading(null, scrolling);
      });
    }
    setTocClass();
    toc();
    setTimeout(function() {
      setAsideTOC();
    }, 1000);
  });</script></body>
</html>
