<!DOCTYPE html><html lang="zh">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>可执行文件名中包含 install 或 setup - 浅浅蓝的博客</title>
<meta name="description" content="问题描述在 Windows Vista+ 系统下，若 EXE 文件名中包含有「install」、「update」或「setup」等字样，可能出现如下问题：      每次软件运行完退出后会弹出「程序兼容性助手」（Program Compatibility Assistant, 简称 PCA），提示软件未正确安装。...">
<link rel="canonical" href="http://localhost:4000/windows/2013/05/19/when-your-exe-name-contains-install-or-setup.html"><link rel="alternate" type="application/rss+xml" title="浅浅蓝的博客" href="http://localhost:4000/feed.xml">
<!-- for Safari on iOS https://developer.apple.com/ios/human-interface-guidelines/icons-and-images/app-icon/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/logo/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/images/logo/icon-167x167.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/logo/icon-152x152.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/logo/icon-120x120.png"><link rel="shortcut icon" href="/assets/images/logo/icon-120x120.png">
<!-- for Chrome on Android https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="192x192" href="/assets/images/logo/icon-192x192.png">
<!-- for Edge on Windows 10 https://msdn.microsoft.com/en-us/library/dn255024(v=vs.85).aspx --><meta name="msapplication-TileImage" content="/assets/images/logo/icon-144x144.png"><meta name="msapplication-square310x310logo" content="/assets/images/logo/icon-310x310.png"><meta name="msapplication-wide310x150logo" content="/assets/images/logo/icon-310x150.png"><meta name="msapplication-square150x150logo" content="/assets/images/logo/icon-150x150.png"><meta name="msapplication-square70x70logo" content="/assets/images/logo/icon-70x70.png">
<meta name="msapplication-TileColor" content="#eeeeee"><link rel="stylesheet" href="/assets/css/blog.css"><script>
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };
  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var Set = (function() {
      var add = function(item) {
        var i, data = this._data;
        for (i = 0; i < data.length; i++) {
          if (data[i] === item) {
            return;
          }
        }
        this.size ++;
        data.push(item);
        return data;
      }

      var Set = function(data) {
        this.size = 0;
        this._data = [];
        if (data.length > 0) {
          for (i = 0; i < data.length; i++) {
            add.call(this, data[i]);
          }
        }
      }
      Set.prototype.add = add;
      Set.prototype.get = function(index) { return this._data[index]; };
      Set.prototype.has = function(item) {
        var i, data = this._data;
        for (i = 0; i < data.length; i++) {
          if (this.get(i) === item) {
            return true;
          }
        }
        return false;
      };
      Set.prototype.is = function(map) {
        if (map._data.length !== this._data.length) { return false; }
        var i, j, flag, tData = this._data, mData = map._data;
        for (i = 0; i < tData.length; i++) {
          for (flag = false, j = 0; j < mData.length; j++) {
            if (tData[i] === mData[j]) {
              flag = true;
              break;
            }
          }
          if (!flag) { return false; }
        }
        return true;
      };
      Set.prototype.values = function() {
        return this._data;
      };
      return Set;
    })();

    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    }
    var end = function(type, url, urls) {
      var s, q, qi, cbs, i, j, cur,
        val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j]
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, si, q, qi, node, i, cur, flag,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  }
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);

  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  }
</script></head>
  <body>
    <div class="m-page-stage js-page-stage">
      <div class="m-page-content"><header class="m-page-header">
  <div class="main clearfix">
    <div class='site-logo'><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#666666;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg><a title="一个热爱前端开发的小姑娘
" href="/">浅浅蓝的博客</a></div>
    <nav>
      <ul><li><a href="/">主页</a></li><li><a href="/all.html">归档</a></li><li><a href="/about.html">关于</a></li><li><a type="application/rss+xml" href="/feed.xml">RSS</a></li>
      </ul>
    </nav>
  </div>
</header>
<div class="m-page-main"><div class="m-post">
	<div class="main clearfix js-main">
		<div class="col-2 js-col-2">
			<aside class="js-article-aside"><div class="m-toc js-toc"></div></aside>
		</div>
		<div class="col-1">
			<article class="js-article" itemscope itemtype="http://schema.org/BlogPosting">
				<meta itemprop="mainEntityOfPage" itemscope itemType="https://schema.org/WebPage"/>
				<header class="main-header"><h1 itemprop="headline" itemprop="name headline">可执行文件名中包含 install 或 setup</h1><div class="m-article-data clearfix"><meta itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="qishunli"/></meta><div class="other-wrapper"><div class="date-wrapper"><time class="article-meta" datetime="2013-05-19T00:00:00+08:00"
          itemprop="datePublished">2013年 05月19日
        </time></div>
  </div>
</div>
</header>
				<div class="m-article-content js-article-content" itemprop="articleBody"><h3 id="问题描述">问题描述</h3>

<p>在 Windows Vista+ 系统下，若 EXE 文件名中包含有「install」、「update」或「setup」等字样，可能出现如下问题：</p>

<ol>
  <li>
    <p>每次软件运行完退出后会弹出「程序兼容性助手」（Program Compatibility Assistant, 简称 PCA），提示软件未正确安装。</p>

    <p><img src="/images/posts/windows/pca.png" alt="" /></p>
  </li>
  <li>
    <p>在 Vista+ 的操作系统下任务栏右键该程序缺少「将此程序锁定到任务栏」和软件名同名项。</p>

    <table>
      <thead>
        <tr>
          <th>程序名</th>
          <th>运行时任务栏右键</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>a.exe</td>
          <td><img src="/images/posts/windows/a.png" alt="" /></td>
        </tr>
        <tr>
          <td>setup.exe</td>
          <td><img src="/images/posts/windows/setup.png" alt="" /></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>你的程序没打算要求管理员权限的，但是运行的时候却弹 UAC 了。</p>

    <p>完全相同的两个 EXE 文件，名字不一样：</p>

    <p><img src="/images/posts/windows/name.png" alt="" /></p>
  </li>
</ol>

<h3 id="问题分析">问题分析</h3>

<p>简而言之，上述现象发生的原因是 Windows Vista+ 系统的「安装程序检测」机制认为文件名中包含「install」、「update」或「setup」等字样，且没有在 Manifest 文件中显式指定 requestedExecutionLevel 的 32 位可执行程序是安装包，会主动为安装包弹出 UAC 提权申请，而「程序兼容性助手」会监控安装包的执行情况，如果它没有在「添加或删除程序」中创建一个条目，那「程序兼容性助手」会认为该安装包没有成功完成，在安装包结束后即弹出「程序兼容性助手」提示用户该程序可能安装不正确。</p>

<p>MSDN 关于「程序兼容性助手」的相关问答：</p>

<blockquote>
  <ol>
    <li>
      <p>What is the detection logic, and how does PCA know that the setup failed due to version problems?</p>

      <p>PCA does not specifically look for the setup’s failing due to version problems. The logic used by PCA is to detect if a setup did not complete successfully. It monitors a program detected as setup by Windows Vista and Windows Server 2008 and checks whether the program registers an entry in Add or Remove Programs (ARP). If no entries are created in ARP, PCA concludes that the installer did not complete successfully. It will then wait for the install program to terminate before displaying the UI. If it is an uninstaller, the detection looks for whether an entry was deleted from ARP.</p>
    </li>
    <li>
      <p>How does PCA get information about the setup programs?</p>

      <p>PCA relies on the User Account Control (UAC) feature in Windows Vista and Windows Server 2008 to know whether a program is a setup program. UAC includes detection for setup programs and will make sure the detected setup programs will be run as Administrator, which includes getting administrative credentials or confirmation from the user before launching the program.</p>
    </li>
  </ol>
</blockquote>

<p>原文链接：<a href="https://msdn.microsoft.com/zh-cn/bb756937">Application Compatibility: Program Compatibility Assistant (PCA)</a></p>

<p>MSDN 关于「安装程序检测」的相关介绍：</p>

<blockquote>
  <p>Installer Detection only applies to:</p>

  <ul>
    <li>32 bit executables</li>
    <li>Applications without a requestedExecutionLevel</li>
    <li>Interactive processes running as a Standard User with UAC enabled</li>
  </ul>

  <p>Before a 32 bit process is created, the following attributes are checked to determine whether it is an installer:</p>

  <ul>
    <li>Filename includes keywords like “install,” “setup,” “update,” etc.</li>
    <li>Keywords in the following Versioning Resource fields: Vendor, Company Name, Product Name, File Description, Original Filename, Internal Name, and Export Name</li>
    <li>Keywords in the side-by-side application manifest embedded in the executable</li>
    <li>Keywords in specific StringTable entries linked in the executable</li>
    <li>Key attributes in the resource file data linked in the executable</li>
    <li>Targeted sequences of bytes within the executable</li>
  </ul>
</blockquote>

<p>原文链接：<a href="https://msdn.microsoft.com/EN-US/library/bb756960(v=VS.10,d=hv.2).aspx">New UAC Technologies for Windows Vista</a></p>

<p>另外，微软的一个 PPT 介绍了「安装程序检测」和它可能产生的误判，以及解决的办法，给出的方案是内嵌 Manifest 或者外置一个名为「MyApp.exe.manifest」的文件：</p>

<ul>
  <li><a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;ved=0CCUQFjABahUKEwiPmdW8rYjJAhVHG5QKHQwjBzY&amp;url=%68%74%74%70%3a%2f%2f%64%6f%77%6e%6c%6f%61%64%2e%6d%69%63%72%6f%73%6f%66%74%2e%63%6f%6d%2f%64%6f%77%6e%6c%6f%61%64%2f%38%2f%43%2f%44%2f%38%43%44%30%31%35%42%42%2d%30%38%31%42%2d%34%39%43%35%2d%41%35%30%36%2d%39%43%39%42%35%37%30%42%38%44%44%32%2f%49%6e%73%74%61%6c%6c%65%72%44%65%74%65%63%74%69%6f%6e%2e%70%70%74%78&amp;usg=AFQjCNHXcaCOv_FFndx0mxn7eovywzKQMg">Installer Detection - Microsoft</a></li>
</ul>

<p>参考：</p>

<ul>
  <li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd371711(v=vs.85).aspx">Application Manifest</a></li>
  <li><a href="https://msdn.microsoft.com/zh-cn/enus/library/bb963893.aspx">Application Compatibility: UAC: Standard User Changes</a></li>
</ul>

<h3 id="解决方案">解决方案</h3>

<p><strong>问题 1：</strong></p>

<p>如下三项任选其一：</p>

<p>一、给程序改个名字，不要包含「install」、「update」和「setup」字样。</p>

<p>二、为可执行文件添加类似如下的 Manifest 文件，指定程序兼容 Win7 与 Vista（或更高版本的当前系统）。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
  <span class="nt">&lt;assembly</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v1"</span> <span class="na">manifestVersion=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;compatibility</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:compatibility.v1"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;application&gt;</span>
        <span class="c">&lt;!--The ID below indicates application support for Windows Vista --&gt;</span>
          <span class="nt">&lt;supportedOS</span> <span class="na">Id=</span><span class="s">"{e2011457-1546-43c5-a5fe-008deee3d3f0}"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--The ID below indicates application support for Windows 7 --&gt;</span>
          <span class="nt">&lt;supportedOS</span> <span class="na">Id=</span><span class="s">"{35138b9a-5d96-4fbd-8e2d-a2440225f93a}"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/application&gt;</span>
    <span class="nt">&lt;/compatibility&gt;</span>
  <span class="nt">&lt;/assembly&gt;</span>
</code></pre></div></div>
<p>三、程序运行时在注册表项 <code class="highlighter-rouge">HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Persisted</code> 下写入以可执行文件全路径为名，值为 REG_DWORD 类型的 1 的项。</p>

<p><strong>问题 2 和 3：</strong></p>

<p>这是 Windows Vista+ 系统对「安装包」的「特殊待遇」，如果你正在做安装包，那你应该不在乎这些；如果你正在做的不是「安装包」，那么将程序改名吧！去掉 install，去掉 update，去掉 setup，世界从此清净了。</p>

<h3 id="结论">结论</h3>

<ol>
  <li>如果你正在做的是安装包，那么遵循 Windows Vista+ 系统对安装包的一致规范，主动要求以管理员权限执行，并在安装任务成功完成后在「添加或删除程序」里添加新的条目。</li>
  <li>如果不是在做安装包，那么将程序改名能避免 Windows Vista+ 系统的误判导致的问题。</li>
</ol>
</div>
				<footer><meta itemprop="dateModified" content="2013-05-19T00:00:00+08:00"><div class="article-license"><div class="m-license"><div class="clearfix"><p>本文遵守 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> 许可协议。</p><a class="license" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
      <img alt="Creative Commons License" src="/assets/images/license-cc4.png" />
    </a><p>欢迎转载，转载需注明出处，且禁止用于商业目的。</p>
  </div>
</div></div>
				</footer>
			</article>
			<div class="article-previous-next clearfix"><div class="article-previous"><span>上篇</span><a href="/cplusplus/2013/06/22/multi-included-source-file.html">文件被多个中间文件输出目录相同的工程包含</a></div><div class="article-next"><span>下篇</span><a href="/windows/2013/04/18/windows-ui-notes.html">Windows 界面相关小知识点</a></div></div></div>
	</div>
</div></div>
      </div>
    </div><div class="m-page-footer js-page-footer">
  <div class="main">
    <aside><div class="follow-me"><ul itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="qishunli">
    <link itemprop="url" href="http://localhost:4000/"></ul></div>
</aside>
    <footer class="site-info">
      <p>© 浅浅蓝的博客 2018</p>
      <p>Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a succinct theme for blogging." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.</p>
    </footer>
  </div>
</div><script>
  (function () {
    var root = document.body
    function classnames(classes) {
      var i, cur, _classes = '';
      if (window.isString(classes)) {
        _classes =  classes;
      } else if (window.isArray(classes)) {
        for (i = 0; i < classes.length; i++) {
          cur = classes[i];
          if (window.isString(cur)) {
            _classes = _classes.concat(_classes ? ' ' + cur : cur);
          }
        }
      } else {
        return '';
      }
      return _classes;
    }
    function addClass(dom, classname) {
      dom.setAttribute('class', classnames([dom.getAttribute('class'), classname]));
    }
    if (window.hasEvent('touchstart')) {
      addClass(root, 'is-touch');
      document.addEventListener("touchstart", function(){}, false);
    } else {
      addClass(root, 'not-touch');
    }
  })();
</script><script>
  (function() {
    function scrollAnimateTo(destination, duration, callback) {
      var $body = $('html, body'), bodyScrollTop = $body.scrollTop();
      if(bodyScrollTop === destination) { return; }
      $body.animate({ scrollTop: destination }, duration, callback);
    }
    window.scrollTopAnchor = function(anchor, callback) {
      scrollAnimateTo($(anchor).offset().top, 400, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
  })();
  window.Lazyload.js('https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', function() {
    var $articleContent = $('.m-post, .m-page').find('.m-article-content'), $this;
    $articleContent.children('.highlight').each(function() {
      $this = $(this);
      $this.attr('data-lang', $this.find('code').attr('data-lang'));
    });

    $articleContent.children('h1, h2, h3, h4, h5, h6').each(function() {
      $this = $(this);
      $this.append($('<a class="anchor" aria-hidden="true"></a>').html('<svg fill="#000000" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'));
    });
    $articleContent.on('click', '.anchor', function() {
      window.scrollTopAnchor('#' + $(this).parent().attr('id'));
    });
  });
</script><script>
  window.Lazyload.js('https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', function() {
    var $window = $(window);
    var $pageStage = $('.js-page-stage');
    var $pageMain = $('.js-main');
    var $pageFooter = $('.js-page-footer');
    var $articleContent = $('.js-article-content');
    var $articleAside = $('.js-article-aside');
    var $toc = $('.js-toc');
    var $col2 = $('.js-col-2');
    var hasTitle = $articleContent.find('h1,h2,h3').length > 0;
    function asideSticky() {
      return $col2.css('display') !== 'none' && $pageStage.hasClass('has-toc');
    }
    function setTocClass() {
      if (hasTitle) {
        !$pageStage.hasClass('has-toc') && $pageStage.addClass('has-toc');
      }
    }
    function setAsideTOC() {
      var asideTop, asideLeft, scrollBottom, asideBottomTop, lastScrollTop;
      function init() {
        var asideOffset = $articleAside.offset();
        var footerOffset = $pageFooter.offset();
        var mainOffset = $pageMain.offset();
        asideTop = mainOffset.top;
        asideHeight = $toc.outerHeight() + parseInt($articleAside.css('padding-top'), 10) + parseInt($articleAside.css('padding-bottom'), 10);
        asideLeft = mainOffset.left + $pageMain.outerWidth() - $articleAside.outerWidth() - parseInt($pageMain.css('padding-right'), 10);
        scrollBottom = footerOffset.top - asideHeight;
        asideBottomTop = scrollBottom - mainOffset.top;
      }
      function setAside(force) {
        force !== true && (force = false);
        var scrollTop = $window.scrollTop();
        if (scrollTop >= asideTop && scrollTop <= scrollBottom) {
          (!force && lastScrollTop >= asideTop && lastScrollTop <= scrollBottom) ||
          $articleAside.addClass('fixed').css({
            left: asideLeft + 'px',
            top: 0
          });
        } else if (scrollTop < asideTop) {
          (!force && lastScrollTop < asideTop) ||
          $articleAside.removeClass('fixed').css({
            left: 0,
            top: 0
          });
        } else {
          (!force && lastScrollTop > scrollBottom) ||
          $articleAside.removeClass('fixed').css({
            left: 0,
            top: asideBottomTop + 'px'
          });
        }
        lastScrollTop = scrollTop;
      }
      asideSticky() && (init(), setAside());
      $window.on('scroll', function() {
        asideSticky() && setAside();
      });
      $window.on('resize', window.throttle(function() {
        setTocClass();
        asideSticky() && (init(), setAside(true));
      }, 100));
      setTimeout(init, 4000);
    }
    function toc() {
      var $tocUl = $('<ul></ul>'), $tocLi, $headings = $articleContent.find('h1,h2,h3'), headingsTop = [],
        scrolling, activeLast, activeCur, rendered = false;
      function init() {
        $headings.each(function() {
          headingsTop.push(Math.floor($(this).offset().top));
        });
      }
      function setActiveHeading(element, disabled) {
        var scrollTop = $window.scrollTop(), i;
        if (disabled || headingsTop.length < 1) { return; }
        if (element) {
          activeCur = element;
        } else {
          for (i = 0; i < headingsTop.length; i++) {
            if (scrollTop >= headingsTop[i]) {
              activeCur = $tocLi.eq(i);
            } else {
              activeCur || (activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        activeLast && activeLast.removeClass('toc-active');
        (activeLast = activeCur).addClass('toc-active');
      }
      function render() {
        $toc.append($tocUl);
        $headings.each(function() {
          var $this = $(this);
          $tocUl.append($('<li></li>').addClass('toc-' + $this.prop("tagName").toLowerCase())
            .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
        });
        $tocLi = $tocUl.children('li');
        $tocUl.on('click', 'a', function(e) {
          e.preventDefault();
          var $this = $(this);
          scrolling = true;
          setActiveHeading($this.parent());
          window.scrollTopAnchor($this.attr('href'), function() {
            scrolling = false;
          });
        });
        rendered = true;
      }
      asideSticky() && (render(), $window.on('load', function() {
        setTimeout(function() {
          init();
          setActiveHeading(null, scrolling);
        }, 1000);
      }));
      $window.on('resize', window.throttle(function() {
        if (asideSticky()) {
          rendered || render();
          init();
          setActiveHeading(null, scrolling);
        }
      }));
      $window.on('scroll', function() {
        asideSticky() && setActiveHeading(null, scrolling);
      });
    }
    setTocClass();
    toc();
    setTimeout(function() {
      setAsideTOC();
    }, 1000);
  });</script></body>
</html>
